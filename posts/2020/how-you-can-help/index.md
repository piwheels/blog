
<p>piwheels is an automated system which attempts to build every version of every package on PyPI on all supported Raspbian versions (Jessie, Stretch and Buster). There's a whole <a href="https://github.com/piwheels/piwheels">codebase</a> and database to manage this process and it works really well. Maintaining this is a reasonable job in itself, but another part of the process is to identify failed builds, and try and fix them.</p>
<p>Fixing a missing package usually boils down to finding out which Debian package is required to build it. For example, you can't install or build the latest version of <a href="https://www.piwheels.org/project/scipy/">scipy</a> without having <code><a href="https://packages.debian.org/buster/pybind11-dev">pybind11-dev</a></code> installed. Once we identify this, we can install the package on the builders and it'll build successfully.</p>
<p>We don't automatically investigate every failed build, that would be an impossible task, and not every failed build is fixable. For example a package that's made to work on Windows only will obviously fail, and we don't need to fix it. Even if a failed build <em>could</em> be fixed, maybe it's not worth the effort because nobody is using it. To put this in perspective, at the time of writing, 1,517,404 builds have succeeded, and 1,381,282 have failed. That's a 52% success rate.</p>
<p><strong>We rely on people reporting missing packages to us on GitHub</strong>. Since package issues are separate from issues with the codebase, we keep them in a separate repo. The codebase lives at <strong><a href="https://github.com/piwheels/piwheels">piwheels/piwheels</a></strong> and the package issues are at <a href="https://github.com/piwheels/packages"><strong>piwheels/packages</strong></a>.</p>
<p>We provide links on each package's <a href="https://www.piwheels.org/project/numpy/">project page</a> to create a GitHub issue if they find a missing package:</p>
<div class="wp-block-image"><figure class="aligncenter size-large"><a href="https://www.piwheels.org/project/numpy/"><img sizes="auto, (max-width: 400px) 100vw, 400px" src="images/piwheels-issue-links.png"/></a></figure></div>
<p>We provide issue templates for people to fill out, to give us all the information we need:</p>
<div class="wp-block-image"><figure class="aligncenter size-large"><a href="https://github.com/piwheels/packages/issues/new/choose"><img sizes="auto, (max-width: 600px) 100vw, 600px" src="images/piwheels-issue-templlate.png"/></a></figure></div>
<p>But most people don't fill these out, which is really unhelpful.</p>
<p>When a user reports a missing package, we investigate the cause of failure. It's really helpful to have the links to the piwheels page and the PyPI page handy. Investigation involves looking in the database to see the output from the build attempt, which is what you'd see if you ran "pip install" yourself on a Pi and it failed. <strong>Most people don't know this, but error messages usually contain information to help you fix the error.</strong> I know, right?</p>
<p>Build output is usually full of garbage from the compiler. We scroll through the output looking for the point of failure, which usually ends up being something like:</p>
<pre class="wp-block-preformatted">2020-01-17T16:10:26   scipy/fft/_pocketfft/pypocketfft.cxx:15:10: fatal error: pybind11/pybind11.h: No such file or directory
2020-01-17T16:10:26    #include 
2020-01-17T16:10:26             ^<del>~~~~</del>
2020-01-17T16:10:26   compilation terminated.</pre>
<p>The key part being fatal error: <code>pybind11/pybind11.h</code></p>
<p>Googling this error will show that the system is missing the <code><a href="https://packages.debian.org/buster/pybind11-dev">pybind11-dev</a></code> Debian package. Knowing that, we can test this by installing the package on a Pi, and seeing if <code>pip3 install &lt;package&gt;</code> or <code>pip3 wheel &lt;package&gt;</code> work.</p>
<p>Once we have a solution, we can install this package on the builders and kick off new builds, which should then yield successful builds, and the issue can be closed.</p>
<p>Unfortunately, finding the time to investigate issues like this is the hard part. piwheels is a 2-person project, and we both have day jobs.</p>
<h2 class="wp-block-heading">Hold the source</h2>
<p>One reason a package might fail to build on Raspberry Pi is that there's no source distribution available on PyPI. Projects like <a href="https://pypi.org/project/tensorflow/">tensorflow</a> don't provide source (zip or tarball) – only binary distributions (wheels) for all the platforms they support. This means there's nothing for piwheels to build from, and this isn't fixable unless they upload a source distribution or send Raspberry Pi wheels directly to us. We manually import wheels for <a href="https://piwheels.org/project/tensorflow/">tensorflow</a> and <a href="https://piwheels.org/project/opencv-python">opencv</a>, and we don't plan to extend this much further – these packages are an exception.</p>
<h2 class="wp-block-heading">Try it yourself</h2>
<p>If you want to try and help, you can pick an issue and try building the package. If it fails:</p>
<ul class="wp-block-list"><li>Read the output and figure out the point of failure</li><li>See if you can find out which Debian package provides the library needed</li><li>Install this package on <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Lite</a> on a Raspberry Pi at home (or a <a href="https://www.mythic-beasts.com/order/rpi">Mythic Beasts Cloud Pi</a>)</li><li>Try to build the wheel with <code>pip3 wheel &lt;package&gt;</code></li><li>If it succeeds, let us know by replying to the GitHub issue</li><li>If it fails, repeat the above</li></ul>
<p>We're working on being able to provide access to failed build logs publicly, but they're not available yet.</p>
<p>Take a look at the <a href="https://github.com/piwheels/packages/issues">existing issues</a> on GitHub, and use the labels and the <a href="https://github.com/piwheels/packages/projects/1">project board</a> to find your way around if necessary.</p>
<h2 class="wp-block-heading">Summary – how can you help?</h2>
<ul class="wp-block-list"><li>If you find a missing package, open an issue and complete the issue template.</li><li>If you see a missing package issue, you can help by trying to build it yourself, and try to identify the cause of the failure. Report your findings to us by replying to the GitHub issue.</li><li>If you want to seek out missing packages, refer to the <a href="https://github.com/piwheels/packages/projects/1">project board</a> or <a href="https://github.com/piwheels/packages/issues">issue list</a>.</li></ul>
<p><em>Just as I was about to publish this article, someone posted a missing package issue. I looked at the output log in the database, identified the missing dependency, installed it, tested building a wheel, and it worked. <a href="https://github.com/piwheels/packages/issues/91">Issue #91</a> closed in a matter of minutes.</em></p>
